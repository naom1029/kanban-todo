= 基本設計

== 1. データモデル設計

データモデルは、ユーザーがタスクを管理するための主要なエンティティとその関係性を定義します。ローカルデータベース（SQLite）とクラウドデータベース（Supabase/PostgreSQL）の両方で同じデータモデルを使用します。

=== 主なエンティティ

1. *User（ユーザー）*
   - `id`: ユーザーID（UUID、主キー）
   - `email`: メールアドレス（ユニーク、必須）
   - `password`: パスワード（ハッシュ化）
   - `name`: ユーザー名
   - `avatar_url`: アバター画像のURL
   - `created_at`: アカウント作成日時
   - `updated_at`: アカウント更新日時

2. *Board（ボード）*
   - `id`: ボードID（UUID、主キー）
   - `title`: ボードのタイトル（必須）
   - `description`: ボードの説明
   - `owner_id`: ボード所有者のユーザーID（外部キー）
   - `is_shared`: 共有ボードかどうかのフラグ（デフォルトは`false`）
   - `created_at`: ボード作成日時
   - `updated_at`: ボード更新日時

3. *BoardMember（ボードメンバー）*
   - `id`: メンバーシップID（UUID、主キー）
   - `board_id`: ボードID（外部キー）
   - `user_id`: ユーザーID（外部キー）
   - `role`: ユーザーの役割（例：`owner`、`editor`、`viewer`）
   - `joined_at`: 参加日時

4. *List（リスト）*
   - `id`: リストID（UUID、主キー）
   - `board_id`: ボードID（外部キー）
   - `title`: リストのタイトル（必須）
   - `position`: リストの順序（整数値）
   - `created_at`: リスト作成日時
   - `updated_at`: リスト更新日時

5. *Card（カード）*
   - `id`: カードID（UUID、主キー）
   - `list_id`: リストID（外部キー）
   - `title`: カードのタイトル（必須）
   - `description`: カードの詳細説明
   - `due_date`: 期限日
   - `position`: カードの順序（整数値）
   - `created_at`: カード作成日時
   - `updated_at`: カード更新日時

6. *CardAssignee（カード担当者）*
   - `id`: 担当者ID（UUID、主キー）
   - `card_id`: カードID（外部キー）
   - `user_id`: ユーザーID（外部キー）

7. *Comment（コメント）*
   - `id`: コメントID（UUID、主キー）
   - `card_id`: カードID（外部キー）
   - `user_id`: 投稿者のユーザーID（外部キー）
   - `content`: コメント内容
   - `created_at`: コメント作成日時
   - `updated_at`: コメント更新日時

8. *Label（ラベル）*
   - `id`: ラベルID（UUID、主キー）
   - `board_id`: ボードID（外部キー）
   - `name`: ラベル名
   - `color`: ラベルの色コード（例：`#FF0000`）

9. *CardLabel（カードラベル）*
   - `id`: 関連ID（UUID、主キー）
   - `card_id`: カードID（外部キー）
   - `label_id`: ラベルID（外部キー）

10. *Checklist（チェックリスト）*
    - `id`: チェックリストID（UUID、主キー）
    - `card_id`: カードID（外部キー）
    - `title`: チェックリストのタイトル

11. *ChecklistItem（チェックリストアイテム）*
    - `id`: アイテムID（UUID、主キー）
    - `checklist_id`: チェックリストID（外部キー）
    - `content`: アイテム内容
    - `is_checked`: チェック済みかどうかのフラグ（デフォルトは`false`）

=== エンティティ間の関係

- *User* と *Board*: 1対多（ユーザーは複数のボードを所有）
- *Board* と *BoardMember*: 1対多（ボードは複数のメンバーを持つ）
- *BoardMember* と *User*: 多対1（メンバーシップは1人のユーザーに属する）
- *Board* と *List*: 1対多（ボードは複数のリストを持つ）
- *List* と *Card*: 1対多（リストは複数のカードを持つ）
- *Card* と *CardAssignee*: 1対多（カードは複数の担当者を持つ）
- *Card* と *Comment*: 1対多（カードは複数のコメントを持つ）
- *Board* と *Label*: 1対多（ボードは複数のラベルを持つ）
- *Card* と *CardLabel*: 1対多（カードは複数のラベルを持つ）
- *Label* と *CardLabel*: 1対多（ラベルは複数のカードに関連付けられる）
- *Card* と *Checklist*: 1対多（カードは複数のチェックリストを持つ）
- *Checklist* と *ChecklistItem*: 1対多（チェックリストは複数のアイテムを持つ）

== 2. 画面設計

画面設計では、ユーザーがアプリケーションを操作するための主要な画面を定義します。Next.jsとshadcnを用いて、モダンでレスポンシブなUIを構築します。

=== 2.1 ログイン画面

- **要素**
  - ロゴ・アプリ名
  - メールアドレス入力欄
  - パスワード入力欄
  - ログインボタン
  - 新規登録リンク
  - パスワードを忘れた場合のリンク
- **機能**
  - ユーザー認証（Supabaseの認証機能を使用）

=== 2.2 新規登録画面

- **要素**
  - ユーザー名入力欄
  - メールアドレス入力欄
  - パスワード入力欄
  - パスワード確認入力欄
  - 登録ボタン
  - ログイン画面へのリンク
- **機能**
  - 新規ユーザー登録

=== 2.3 ダッシュボード画面

- **要素**
  - ヘッダー（ユーザー情報、設定メニュー、ログアウトボタン）
  - ボード一覧表示（自分のボードと共有ボードをタブで切り替え）
  - ボード作成ボタン
- **機能**
  - ボードの作成・閲覧
  - ボードの検索・フィルタリング

=== 2.4 ボード画面

- **要素**
  - ボード名表示と編集
  - メンバー一覧表示と招待機能
  - リストエリア（横スクロール対応）
    - 各リストのタイトルとカード一覧
    - リストの追加ボタン
  - カード追加ボタン（各リスト内）
- **機能**
  - リストの作成・編集・削除
  - カードの作成・編集・削除
  - ドラッグ＆ドロップによるリストおよびカードの並び替え

=== 2.5 カード詳細画面（モーダルまたは別ページ）

- **要素**
  - カードタイトルと編集機能
  - 詳細説明の表示・編集
  - 担当者の表示・追加・削除
  - 期限日の設定・編集
  - ラベルの表示・追加・削除
  - チェックリストの表示・追加・編集
  - 添付ファイルの表示・アップロード・ダウンロード
  - コメント欄（投稿・閲覧）
- **機能**
  - カードに関連するすべての情報の閲覧・編集
  - コメントの投稿・削除

=== 2.6 設定画面

- **要素**
  - プロフィール情報の表示・編集（ユーザー名、メールアドレス、アバター）
  - パスワードの変更
  - 通知設定
- **機能**
  - ユーザー情報の更新
  - アプリ設定のカスタマイズ

=== 2.7 オフライン画面

- **要素**
  - オフライン状態の通知バー
  - オフライン時に利用可能な機能の案内
- **機能**
  - オフライン時には自分のタスクのみ閲覧・編集可能であることを明示

=== 2.8 エラーページ

- **要素**
  - エラーメッセージ
  - ホームへのリンクまたは再試行ボタン
- **機能**
  - 各種エラー発生時のユーザーへの通知

== 3. 機能設計

機能設計では、各機能がどのように動作するか、ユーザーの操作とシステムの処理を明確にします。

=== 3.1 ユーザー認証機能

- **ログイン**
  - ユーザーがメールアドレスとパスワードを入力し、Supabaseの認証APIを呼び出す。
  - 認証成功時にユーザー情報を取得し、アプリ内でセッションを開始。
- **新規登録**
  - ユーザーが必要な情報を入力し、Supabaseのユーザー作成APIを呼び出す。
  - 登録成功後、自動的にログイン状態にするか、ログイン画面にリダイレクト。
- **ログアウト**
  - セッション情報をクリアし、ログイン画面にリダイレクト。

=== 3.2 ボード管理機能

- **ボードの作成**
  - ユーザーがボード名を入力し、`Board`テーブルに新規レコードを作成。
  - `BoardMember`テーブルに所有者としてのメンバーシップを作成。
- **ボードの共有**
  - 他のユーザーのメールアドレスを入力し、`BoardMember`テーブルに新規メンバーを追加。
  - 招待されたユーザーに通知を送信（オンライン時）。
- **ボードの編集・削除**
  - ボード情報を更新または削除する機能。
  - 削除時には関連するリスト、カード、メンバーシップも削除。

=== 3.3 リスト管理機能

- **リストの作成**
  - ボード内でリスト名を入力し、`List`テーブルに新規レコードを作成。
- **リストの並び替え**
  - ドラッグ＆ドロップ操作で`position`フィールドを更新。
- **リストの編集・削除**
  - リスト名の変更やリストの削除機能。

=== 3.4 カード管理機能

- **カードの作成**
  - リスト内でカード名を入力し、`Card`テーブルに新規レコードを作成。
- **カードの移動**
  - ドラッグ＆ドロップ操作で`list_id`および`position`を更新。
- **カードの編集**
  - タイトル、説明、期限日、担当者、ラベル、チェックリスト、添付ファイルなどを更新。
- **カードの削除**
  - カードおよび関連するコメント、チェックリスト、添付ファイルを削除。

=== 3.5 コメント機能

- **コメントの投稿**
  - カード詳細画面でコメントを入力し、`Comment`テーブルに新規レコードを作成。
- **コメントの表示**
  - カードに関連するコメントを時系列で表示。
- **コメントの削除**
  - 自分のコメントを削除可能。

=== 3.6 通知機能

- **リアルタイム通知**
  - Supabaseのリアルタイム機能（Realtime API）を使用して、データの変更を監視。
  - 他のメンバーによるタスクの更新やコメント投稿を通知。
- **通知設定**
  - ユーザーが受け取りたい通知の種類を設定可能。

=== 3.7 オフライン対応機能

- **データのキャッシュ**
  - IndexedDBまたはSQLiteを使用してローカルにデータを保存。
- **オフライン時の制限**
  - 自分が担当者として割り当てられたタスクのみ閲覧・編集可能。
  - 他のユーザーや共有ボードのデータはオフライン時にはアクセス不可。
- **データ同期**
  - オンライン復帰時にローカルデータとクラウドデータを自動的に同期。
  - コンフリクト解消機能は将来的な実装とし、現時点ではクラウドデータを優先するかユーザーに通知。

=== 3.8 検索・フィルタリング機能

- **キーワード検索**
  - ボード内のカードをタイトルや説明で検索。
- **フィルタリング**
  - ラベル、担当者、期限日などの条件でカードを絞り込み。

=== 3.9 設定・プロフィール機能

- **ユーザー情報の更新**
  - プロフィール画面でユーザー名やアバターを変更。
- **パスワードの変更**
  - 現在のパスワードと新しいパスワードを入力し、Supabaseの認証APIを呼び出す。
- **通知設定の更新**
  - 通知の種類や頻度を設定。

=== 3.10 セキュリティ・認証機能

- **データの暗号化**
  - 通信時にはHTTPSを使用し、データ保存時には必要に応じて暗号化。
- **アクセス制御**
  - ユーザーごとのアクセス権限を確認し、不正な操作を防止。
